---
title: "Quantificação de Doenças em Plantas - EPAMIG"
output: 
  html_document:
    toc: false
    theme: cosmo
    highlight: tango
runtime: shiny
---

<style type="text/css">
  .main-container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; max-height: 100% !important}
  .container-fluid { padding-left: 15px !important; padding-right: 15px !important; }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Pacotes (Adicionado shinyjs para controle de interface)
pkgs <- c("shiny", "DT", "base64enc", "BiocManager", "shinycssloaders")
for(p in pkgs) if(!require(p, character.only=T)) install.packages(p)

if (!require("EBImage", quietly = TRUE)) {
  BiocManager::install("EBImage")
  library("EBImage")
}
```

## Sistema Integrado de Análise de Folhas

Esta ferramenta unifica a análise detalhada (para calibração) e a análise em lote (para produtividade).

```{r app_wide, echo=FALSE}
# --- PACOTES ---
library(shiny)
library(EBImage)       
library(DT)
library(shinycssloaders)
library(base64enc)

# --- CONFIGURAÇÕES FIXAS (HARDCODED) ---
PARAM_FUNDO <- 0.3   # Limiar para separar a folha do fundo
PARAM_DOENCA <- 0.1  # Sensibilidade para detectar a doença

# --- FUNÇÕES AUXILIARES ---
force_landscape <- function(img) {
  if(dim(img)[1] < dim(img)[2]) { return(rotate(img, -90)) }
  return(img)
}

img_to_base64 <- function(img) {
  tmp <- tempfile(fileext = ".png")
  tryCatch({
    writeImage(img, tmp)
    txt <- base64enc::dataURI(file=tmp, mime="image/png")
    unlink(tmp)
    return(txt)
  }, error = function(e) return(""))
}

# --- CSS SIMPLIFICADO ---
custom_css <- "
  .big-metric { 
    text-align: center; 
    padding: 20px; 
    background-color: #f7f9f9; 
    border: 2px solid #2c3e50; 
    border-radius: 10px; 
    margin-top: 20px;
  }
  .big-metric h2 { color: #7f8c8d; font-size: 1.2em; margin: 0; }
  .big-metric h1 { color: #e74c3c; font-size: 3.5em; font-weight: bold; margin: 5px 0 0 0; }
  .img-box { 
    border: 1px solid #ddd; 
    background: #eee; 
    min-height: 250px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  .img-box img { max-width: 100%; max-height: 300px; }
  
  /* Estilo do Rodapé */
  .author-footer {
    text-align: center;
    margin-top: 40px;
    padding: 20px;
    border-top: 1px solid #dcdcdc;
    background-color: #fdfdfd;
    color: #555;
    font-size: 0.9em;
  }
"

# --- UI ---
ui <- navbarPage("Análise Simplificada", id = "nav_main",
  tags$head(tags$style(HTML(custom_css))),

  # ABA 1: INDIVIDUAL
  tabPanel("Análise Individual", icon = icon("microscope"),
    fluidRow(
      column(3,
        wellPanel(
          h4("Carregar Imagem"),
          fileInput("file_single", NULL, accept = c("image/png", "image/jpeg"))
          ),
        # Resultado da Severidade em destaque
        uiOutput("out_severidade_box")
      ),
      column(9,
        fluidRow(
          column(4, h5("Original"), div(class="img-box", withSpinner(uiOutput("out_img_orig"), type=4))),
          column(4, h5("Recorte (Máscara)"), div(class="img-box", withSpinner(uiOutput("out_img_mask"), type=4))),
          column(4, h5("Doença Detectada"), div(class="img-box", withSpinner(uiOutput("out_img_res"), type=4)))
        )
      )
    )
  ),

  # ABA 2: LOTE
  tabPanel("Processamento em Lote", icon = icon("layer-group"),
    fluidRow(
      column(3,
        wellPanel(
          h4("Carregar Lote"),
          fileInput("files_batch", "Selecionar Imagens", multiple = TRUE, accept = c("image/png", "image/jpeg")),
          helpText("O processamento iniciará automaticamente.")
        )
      ),
      column(9,
        h4("Tabela de Resultados"),
        withSpinner(DT::dataTableOutput("table_batch_results"), type=4),
        br(),
        downloadButton("btn_download_batch", "Baixar Tabela (CSV)", class="btn-success")
      )
    )
  ),

# RODAPÉ ATUALIZADO
  footer = div(class = "author-footer",
      # Linha 1: Principal
      div(
        strong("Autor:"), " Silva Júnior, A. C.", tags$sup("1"), " | ",
        em("EPAMIG - antonio.silva.c.junior@gmail.com"), " | ",
        span(format(Sys.Date(), '%d de %B de %Y'))
      ),
      
      # Linha 2: Descrição do Sobrescrito (1)
      div(class = "footer-note",
        tags$sup("1"), " Antônio Carlos da Silva Júnior, pós-doutorando, EPAMIG, MG, Brasil"
      ),
      
      # Linha 3: Produzido por
      div(class = "footer-note",
        "*Produzido por: Costa, W.G.; ", " | ",
        em("weverton.costa@ufv.br"), " | ",
        tags$a(href="https://wevertongomescosta.github.io/", target="_blank", "https://wevertongomescosta.github.io/")
      )
  )
)

# --- SERVER ---
server <- function(input, output, session) {

  # ==========================
  # 1. LÓGICA INDIVIDUAL
  # ==========================
  vals_single <- reactiveValues(orig = NULL, mask = NULL, res = NULL, sev = NULL)

  observeEvent(input$file_single, {
    req(input$file_single)
    
    # 1. Ler e Preparar
    img <- readImage(input$file_single$datapath)
    if(colorMode(img) == Grayscale) img <- toRGB(img)
    if(length(dim(img)) == 3 && dim(img)[3] == 4) img <- img[,,1:3]
    img <- force_landscape(img)
    img <- resize(img, w=600)
    colorMode(img) <- Color
    
    vals_single$orig <- img
    
    # 2. Processar Máscara (Fundo)
    mask <- (img[,,2] + img[,,1]) > (img[,,3] + PARAM_FUNDO)
    mask_img <- fillHull(closing(Image(mask, colormode="Grayscale"), makeBrush(5, shape='disc')))
    
    # Pegar maior objeto (folha)
    labels <- bwlabel(mask_img)
    if(max(labels) > 0) {
      mask_final <- (labels == which.max(computeFeatures.shape(labels)[,"s.area"]))
    } else {
      mask_final <- (as.array(mask_img) > 0)
    }
    vals_single$mask <- mask_final
    
    # 3. Processar Doença
    mask_doenca <- ((img[,,1] - img[,,2]) > PARAM_DOENCA) & mask_final
    
    # 4. Calcular Severidade
    af <- sum(mask_final)
    ad <- sum(mask_doenca)
    sev <- if(af > 0) (ad/af)*100 else 0
    vals_single$sev <- sev
    
    # Imagem Visual da Doença
    vals_single$res <- paintObjects(Image(mask_doenca, colormode="Grayscale"), img, col="red", opac=c(1, 0.7), thick=TRUE)
  })

  # Outputs Individuais
  output$out_img_orig <- renderUI({ req(vals_single$orig); tags$img(src = img_to_base64(vals_single$orig)) })
  output$out_img_mask <- renderUI({ req(vals_single$mask); tags$img(src = img_to_base64(paintObjects(Image(vals_single$mask, colormode="Grayscale"), vals_single$orig, col="blue", opac=c(1, 0.4), thick=TRUE))) })
  output$out_img_res  <- renderUI({ req(vals_single$res);  tags$img(src = img_to_base64(vals_single$res)) })
  
  output$out_severidade_box <- renderUI({
    req(vals_single$sev)
    div(class="big-metric",
      h2("SEVERIDADE"),
      h1(paste0(round(vals_single$sev, 2), "%"))
    )
  })

  # ==========================
  # 2. LÓGICA EM LOTE
  # ==========================
  batch_data <- reactiveVal(data.frame())

  observeEvent(input$files_batch, {
    req(input$files_batch)
    
    temp_df <- data.frame()
    n <- nrow(input$files_batch)
    
    withProgress(message = 'Processando Lote...', value = 0, {
      for(i in 1:n){
        tryCatch({
          # Leitura
          path <- input$files_batch$datapath[i]
          fname <- input$files_batch$name[i]
          
          img <- readImage(path)
          if(colorMode(img) == Grayscale) img <- toRGB(img)
          if(length(dim(img)) == 3 && dim(img)[3] == 4) img <- img[,,1:3]
          img <- resize(img, w=500) # Reduz um pouco para acelerar lote
          
          # Cálculo Máscara (Folha)
          mask <- (img[,,2] + img[,,1]) > (img[,,3] + PARAM_FUNDO)
          mask_img <- fillHull(closing(Image(mask, colormode="Grayscale"), makeBrush(5, shape='disc')))
          
          # Cálculo Doença
          mask_doenca <- ((img[,,1] - img[,,2]) > PARAM_DOENCA) & (mask_img > 0)
          
          # Métricas
          af <- sum(mask_img)
          ad <- sum(mask_doenca)
          sev <- if(af > 0) (ad/af)*100 else 0
          
          # Adicionar ao Dataframe
          temp_df <- rbind(temp_df, data.frame(
            Imagem = fname,
            Severidade_Percentual = round(sev, 2),
            Pixels_Totais = af,
            Pixels_Doentes = ad
          ))
          
        }, error = function(e) {
           # Em caso de erro na imagem, preenche com NA
           temp_df <- rbind(temp_df, data.frame(Imagem = fname, Severidade_Percentual = NA, Pixels_Totais = NA, Pixels_Doentes = NA))
        })
        incProgress(1/n, detail = paste("Imagem", i))
      }
    })
    
    batch_data(temp_df)
  })

  # Outputs Lote
  output$table_batch_results <- DT::renderDataTable({
    req(nrow(batch_data()) > 0)
    DT::datatable(batch_data(), options = list(pageLength = 15, dom = 't'), rownames = FALSE)
  })
  
  output$btn_download_batch <- downloadHandler(
    filename = function() { paste0("resultados_lote_", Sys.Date(), ".csv") },
    content = function(file) { write.csv(batch_data(), file, row.names = FALSE) }
  )
}

# --- RODAR APLICAÇÃO ---
shinyApp(ui, server, options = list(height = 750))
```